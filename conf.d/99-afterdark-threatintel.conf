#------------------------------------------------------------------------------
# AfterDark Threat Intelligence Configuration for Amavisd-new
#
# Include this file in your amavisd.conf:
#   include('/etc/amavisd/conf.d/99-afterdark-threatintel.conf');
#
# Or copy these settings directly into amavisd.conf
#------------------------------------------------------------------------------

use lib '/usr/local/lib/amavisd';
use AfterDark::Amavis::ThreatIntel qw(
    $afterdark_enabled
    $dnsscience_enabled
    $dnsscience_api_key
    $dnsscience_api_url
    $dnsscience_dnsbl_zone
    $betterphish_enabled
    $betterphish_api_key
    $betterphish_api_url
    $afterdark_check_ips
    $afterdark_check_urls
    $afterdark_check_hashes
    $afterdark_cache_enabled
    $afterdark_cache_ttl
    $afterdark_cache_file
    $afterdark_timeout
    $afterdark_action_on_phishing
    $afterdark_action_on_malware
    $afterdark_action_on_spam_source
    $afterdark_spam_score_phishing
    $afterdark_spam_score_malware
    $afterdark_spam_score_suspicious
    $afterdark_add_headers
    $afterdark_log_level
);

#------------------------------------------------------------------------------
# MASTER SWITCH
#------------------------------------------------------------------------------

# Enable/disable the entire AfterDark threat intelligence plugin
$afterdark_enabled = 1;

#------------------------------------------------------------------------------
# DNSSCIENCE.IO CONFIGURATION
#------------------------------------------------------------------------------

# Enable DNSScience integration (DNS security, threat intel)
$dnsscience_enabled = 1;

# Your DNSScience API key (get one at https://dnsscience.io/dashboard/api-keys)
# Required for full API access. DNSBL lookups work without API key.
$dnsscience_api_key = '';  # REQUIRED: Set your API key here

# DNSScience API base URL
$dnsscience_api_url = 'https://api.dnsscience.io/v1';

# DNSScience DNSBL zone for IP reputation lookups
# This works without an API key for basic blocklist lookups
$dnsscience_dnsbl_zone = 'dnsbl.dnsscience.io';

#------------------------------------------------------------------------------
# BETTERPHISH.IO CONFIGURATION
#------------------------------------------------------------------------------

# Enable BetterPhish integration (phishing data aggregator)
$betterphish_enabled = 1;

# Your BetterPhish API key (optional, but recommended for higher rate limits)
# Get one at https://betterphish.io/pricing
$betterphish_api_key = '';  # Optional: Set your API key here

# BetterPhish API base URL
$betterphish_api_url = 'https://api.betterphish.io/v1';

#------------------------------------------------------------------------------
# CHECK TYPES
#------------------------------------------------------------------------------

# Check sender IP addresses against DNSBL and threat intel
$afterdark_check_ips = 1;

# Check URLs found in message body against phishing databases
$afterdark_check_urls = 1;

# Check attachment hashes against malware databases
$afterdark_check_hashes = 1;

#------------------------------------------------------------------------------
# ACTIONS PER THREAT TYPE
#
# Available actions:
#   REJECT     - Reject the message with 5xx SMTP error
#   QUARANTINE - Accept but quarantine the message
#   TAG        - Accept but add headers indicating threat
#   SCORE      - Add spam score points only
#   PASS       - Take no action (just log)
#------------------------------------------------------------------------------

# Action when phishing is detected (URLs, domains, content)
$afterdark_action_on_phishing = 'REJECT';

# Action when malware is detected (file hashes, known malware)
$afterdark_action_on_malware = 'REJECT';

# Action when message is from known spam source (IP blocklist)
$afterdark_action_on_spam_source = 'SCORE';

#------------------------------------------------------------------------------
# SPAM SCORING
#
# These scores are added to SpamAssassin's score when threats are detected.
# Only applies when action is SCORE or TAG.
#------------------------------------------------------------------------------

# Score added for confirmed phishing
$afterdark_spam_score_phishing = 10.0;

# Score added for confirmed malware
$afterdark_spam_score_malware = 15.0;

# Score added for suspicious/spam source IPs
$afterdark_spam_score_suspicious = 3.0;

#------------------------------------------------------------------------------
# CACHING
#------------------------------------------------------------------------------

# Enable result caching (strongly recommended to reduce API calls)
$afterdark_cache_enabled = 1;

# Cache TTL in seconds (default: 1 hour)
$afterdark_cache_ttl = 3600;

# Cache file location (must be writable by amavis user)
$afterdark_cache_file = '/var/lib/amavis/afterdark_cache.db';

#------------------------------------------------------------------------------
# PERFORMANCE
#------------------------------------------------------------------------------

# API request timeout in seconds
$afterdark_timeout = 5;

#------------------------------------------------------------------------------
# HEADERS & LOGGING
#------------------------------------------------------------------------------

# Add X-AfterDark-* headers to processed messages
$afterdark_add_headers = 1;

# Logging level: 0=none, 1=errors only, 2=info, 3=debug
$afterdark_log_level = 2;

#------------------------------------------------------------------------------
# INITIALIZE THE PLUGIN
#------------------------------------------------------------------------------

# Call init() after configuration is complete
AfterDark::Amavis::ThreatIntel::init();

#------------------------------------------------------------------------------
# CUSTOM POLICY BANK EXAMPLE (Optional)
#
# You can create policy banks for different domains or users
#------------------------------------------------------------------------------

# Example: Stricter policy for financial domain
# $policy_bank{'financial.example.com'} = {
#     afterdark_action_on_phishing => 'REJECT',
#     afterdark_action_on_malware  => 'REJECT',
#     afterdark_spam_score_suspicious => 5.0,
# };

# Example: Relaxed policy for marketing (more false positives expected)
# $policy_bank{'marketing.example.com'} = {
#     afterdark_action_on_phishing => 'TAG',
#     afterdark_action_on_spam_source => 'PASS',
# };

1;  # Perl requires this
